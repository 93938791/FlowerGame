<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlowerGame 控制台</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/vue@3.5.12/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/naive-ui@2.39.0/dist/index.prod.js"></script>
  <style>
    body { margin: 0; background: #f5f7fa; }
    #app { padding: 24px; max-width: 1100px; margin: 0 auto; }
    .card { margin-bottom: 16px; }
    pre { background: #f8f8f8; padding: 12px; border-radius: 8px; overflow: auto; }
  </style>
</head>
<body>
  <div id="app">
    <n-space vertical>
      <n-h1>FlowerGame 控制台</n-h1>
      <n-text depth="3">本机服务：<span id="base"></span></n-text>

      <n-card class="card" title="Microsoft 登录">
        <n-space>
          <n-button type="primary" @click="authorize">获取授权URL并打开</n-button>
        </n-space>
        <n-space style="margin-top: 12px;">
          <n-input v-model:value="authCode" placeholder="粘贴授权 code" style="max-width: 360px;" />
          <n-button @click="authenticate" type="success">提交认证</n-button>
          <n-button @click="authStatus">查看状态</n-button>
        </n-space>
        <pre style="margin-top: 12px;">{{ authOut }}</pre>
      </n-card>

      <n-card class="card" title="Minecraft 下载">
        <n-space>
          <n-button @click="listVersions">获取版本清单</n-button>
        </n-space>
        <n-space style="margin-top: 12px;">
          <n-input v-model:value="versionId" placeholder="如 1.21.1" style="max-width: 160px;" />
          <n-input v-model:value="customName" placeholder="自定义名称可选" style="max-width: 200px;" />
          <n-button type="primary" @click="downloadVersion">下载原版</n-button>
        </n-space>
        <pre style="margin-top: 12px;">{{ dlOut }}</pre>
      </n-card>

      <n-card class="card" title="Syncthing 控制">
        <n-space>
          <n-button type="primary" @click="synStart">启动</n-button>
          <n-button type="error" @click="synStop">停止</n-button>
          <n-button @click="synInfo">设备ID/流量</n-button>
        </n-space>
        <pre style="margin-top: 12px;">{{ synOut }}</pre>
      </n-card>

      <n-card class="card" title="Easytier 控制">
        <n-space>
          <n-button type="primary" @click="etStart">启动</n-button>
          <n-button type="error" @click="etStop">停止</n-button>
          <n-button @click="etPeers">发现设备</n-button>
          <n-button @click="etTraffic">流量统计</n-button>
        </n-space>
        <pre style="margin-top: 12px;">{{ etOut }}</pre>
      </n-card>
    </n-space>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;
    const { NSpace, NH1, NText, NCard, NButton, NInput } = naive;

    createApp({
      components: { nSpace: NSpace, nH1: NH1, nText: NText, nCard: NCard, nButton: NButton, nInput: NInput },
      setup() {
        const base = `${location.protocol}//${location.host}`;
        onMounted(() => { document.getElementById('base').textContent = base; });

        const authCode = ref('');
        const authOut = ref('');
        const versionId = ref('');
        const customName = ref('');
        const dlOut = ref('');
        const synOut = ref('');
        const etOut = ref('');

        async function authorize() {
          const r = await fetch('/api/auth/authorize-url');
          const j = await r.json();
          authOut.value = JSON.stringify(j, null, 2);
          if (j.url) window.open(j.url, '_blank');
        }
        async function authenticate() {
          const r = await fetch('/api/auth/authenticate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ auth_code: authCode.value.trim() }) });
          authOut.value = JSON.stringify(await r.json(), null, 2);
        }
        async function authStatus() {
          const r = await fetch('/api/auth/status');
          authOut.value = JSON.stringify(await r.json(), null, 2);
        }
        async function listVersions() {
          const r = await fetch('/api/minecraft/versions');
          dlOut.value = JSON.stringify(await r.json(), null, 2);
        }
        async function downloadVersion() {
          const r = await fetch('/api/minecraft/download', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ version_id: versionId.value.trim(), custom_name: customName.value.trim() || null }) });
          dlOut.value = JSON.stringify(await r.json(), null, 2);
        }
        async function synStart() {
          const r = await fetch('/api/syncthing/start', { method: 'POST' });
          synOut.value = await r.text();
        }
        async function synStop() {
          const r = await fetch('/api/syncthing/stop', { method: 'POST' });
          synOut.value = await r.text();
        }
        async function synInfo() {
          const r1 = await fetch('/api/syncthing/device-id');
          const id = await r1.json();
          const r2 = await fetch('/api/syncthing/traffic');
          const traf = await r2.json();
          synOut.value = JSON.stringify({ id, traf }, null, 2);
        }
        async function etStart() {
          const r = await fetch('/api/easytier/start', { method: 'POST' });
          etOut.value = await r.text();
        }
        async function etStop() {
          const r = await fetch('/api/easytier/stop', { method: 'POST' });
          etOut.value = await r.text();
        }
        async function etPeers() {
          const r = await fetch('/api/easytier/peers');
          etOut.value = JSON.stringify(await r.json(), null, 2);
        }
        async function etTraffic() {
          const r = await fetch('/api/easytier/traffic');
          etOut.value = JSON.stringify(await r.json(), null, 2);
        }

        return { authCode, authOut, versionId, customName, dlOut, synOut, etOut, authorize, authenticate, authStatus, listVersions, downloadVersion, synStart, synStop, synInfo, etStart, etStop, etPeers, etTraffic };
      }
    }).mount('#app');
  </script>
</body>
</html>
